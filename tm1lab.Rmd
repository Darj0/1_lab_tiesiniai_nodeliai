---
title: "test"
author: "vilte"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
data <- read.csv("/Users/vilte/Desktop/archive/CO2 Emissions_Canada.csv",
                 stringsAsFactors = FALSE)
# Remove only the second-to-last column
data <- data[, - (ncol(data) - 1)]

data$logCO2 <- log(data$CO2.Emissions.g.km.)
names(data) <- c("Markė",
                 "Modelis",
                 "Kėbulo tipas",
                 "Variklio tūris (l)",
                 "Cilindrų kiekis",
                 "Pavarų dėžės tipas",
                 "Kuro tipas",
                 "Kuro sąnaudos mieste (l/100km)",
                 "Kuro sąnaudos greitkelyje (l/100km)",
                 "Vidutinės kuro sąnaudos (l/100km)",
                 "Vidutinės kuro sąnaudos (mpg)",
                 "CO2 emisijos (g/km)")


```

```{r}

# Histogram su log10 transformuotu stulpeliu
hist(data$`CO2 emisijos (g/km)`,
     breaks = 40,
     probability = TRUE,
     main = "Logaritmiškai transformuotų automobilių CO2 emisijų pasiskirstymo histograma",
     xlab = "CO2 emisijos (g/km)",
     ylab = "Tankis",
     col = "lightblue",
     border = "black")

# Normaliosios kreivės pridėjimas
x <- seq(min(data$`CO2 emisijos (g/km)`, na.rm=TRUE), max(data$`CO2 emisijos (g/km)`, na.rm=TRUE), length=100)
y <- dnorm(x, 
           mean=mean(data$`CO2 emisijos (g/km)`, na.rm=TRUE), 
           sd=sd(data$`CO2 emisijos (g/km)`, na.rm=TRUE))
lines(x, y, col="red", lwd=2)

legend("topright",
       legend = c("CO2 emisijų pasiskirstymas", "Normalumo kreivė"),
       col    = c("lightblue", "red"),
       lwd    = c(10, 2),       # stulpelis (histograma) ir linija (kreivė)
       bty    = "n")            # be rėmelio
```

```{r}
library(corrplot)
# 1. Prepare numeric variables:
numeric_vars <- data[, sapply(data, is.numeric)]
colnames(numeric_vars) <- c("Variklio tūris (l)",
                            "Cilindrų\nkiekis",
                            "Kuro sąnaudos\nmieste (l/100km)",
                            "Kuro sąnaudos\ngreitkelyje (l/100km)",
                            "Vidutinės kuro\nsąnaudos (l/100km)",
                            "Vidutinės kuro\nsąnaudos (mpg)",
                            "CO2 emisijos (g/km)")

# 2. Correlation matrix
cor_matrix <- cor(numeric_vars, use = "complete.obs")

# Correlation plot

corrplot(cor_matrix, method = "number", type = "upper",
         tl.col = "black", tl.srt = 90 , number.cex = 0.9)


mtext("Kiekybinių kintamųjų koreliacijų matrica",
      side = 3,       # top
      line = -10,       # closer to plot (try -1, 0, or 1)
      cex = 1.2,      # text size
      font = 2,       # bold
      adj = 0.7)      # 0 = left, 0.5 = center, 1 = right

library(GGally)
library(ggplot2)

# Funkcija viršutinei daliai (sklaidos taškai + regresija)
upper_fun <- function(data, mapping, ...) {
  ggplot(data, mapping) +
    geom_point(alpha = 0.5, color = "blue") +         
    geom_smooth(method = "lm", se = FALSE, color = "red", lwd = 1) + 
    theme_minimal()
}

# Funkcija įstrižainei (tik kintamojo pavadinimas centre)
diag_fun <- function(data, mapping, ...) {
  var <- as_label(mapping$x)
  ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = var, size = 4, fontface = "bold") +
    theme_void()
}

# Pair plot į objektą
p <- suppressMessages(
  suppressWarnings(
    ggpairs(numeric_vars,
            upper = list(continuous = upper_fun),   
            lower = list(continuous = "blank"),     
            diag  = list(continuous = "blank"),    
            progress = FALSE) +
      ggtitle("Sklaidos diagramos tarp kiekybinių kintamųjų") +
      theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
)

# Išsaugoti kaip PNG į Desktop
ggsave(filename = "/Users/vilte/Desktop/scatter_matrix.png",
       plot = p, width = 12, height = 12, dpi = 300)

```
```{r}
library(dplyr)
library(ggplot2)

dep_var <- "CO2 emisijos (g/km)"

# ===== 1. Top 10 markių pagal CO2 =====
top_brands <- data %>%
  group_by(Markė) %>%
  filter(n() >= 10) %>%
  summarise(mean_CO2 = mean(`CO2 emisijos (g/km)`, na.rm = TRUE)) %>%
  arrange(desc(mean_CO2)) %>%
  slice_head(n = 10) %>%
  pull(Markė)

data_brands <- data %>% filter(Markė %in% top_brands)

p1 <- ggplot(data_brands, aes(x = Markė, y = `CO2 emisijos (g/km)`, fill = Markė)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = rainbow(length(top_brands))) +
  theme_minimal() +
  labs(title = "Top 10 markių pagal vidutinę CO2 emisiją",
       x = "Markė",
       y = "CO2 emisijos (g/km)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none")
print(p1)


# ===== 2. Top 10 modelių pagal CO2 =====
top_models <- data %>%
  group_by(Modelis) %>%
  filter(n() >= 10) %>%
  summarise(mean_CO2 = mean(`CO2 emisijos (g/km)`, na.rm = TRUE)) %>%
  arrange(desc(mean_CO2)) %>%
  slice_head(n = 10) %>%
  pull(Modelis)

data_models <- data %>% filter(Modelis %in% top_models)

p2 <- ggplot(data_models, aes(x = Modelis, y = `CO2 emisijos (g/km)`, fill = Modelis)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = rainbow(length(top_models))) +
  theme_minimal() +
  labs(title = "Top 10 modelių pagal vidutinę CO2 emisiją",
       x = "Modelis",
       y = "CO2 emisijos (g/km)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none")
print(p2)


# ===== Funkcija kategoriniams kintamiesiems su vaivorykšte =====
plot_box_rainbow <- function(data, var_name) {
  n_levels <- length(unique(data[[var_name]]))
  colors <- rainbow(n_levels)
  ggplot(data, aes(x = .data[[var_name]], y = `CO2 emisijos (g/km)`, fill = .data[[var_name]])) +
    geom_boxplot(color = "black") +
    scale_fill_manual(values = colors) +
    theme_minimal() +
    labs(title = paste("CO2 emisijos pagal", var_name),
         x = var_name,
         y = "CO2 emisijos (g/km)") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "none")
}

# 3. Kėbulo tipas
p3 <- plot_box_rainbow(data, "Kėbulo tipas")
print(p3)

# 4. Pavarų dėžės tipas
p4 <- plot_box_rainbow(data, "Pavarų dėžės tipas")
print(p4)

# 5. Kuro tipas
p5 <- plot_box_rainbow(data, "Kuro tipas")
print(p5)
```
```{r}
library(dplyr)

# Funkcija dažnių lentelei kaip data frame
freq_table_df <- function(data, var_name) {
  data %>%
    group_by(.data[[var_name]]) %>%
    summarise(Count = n(), .groups = "drop") %>%
    #mutate(Percentage = round(Count / sum(Count) * 100, 2)) %>%
    arrange(desc(Count))
}

# 1. Markė
freq_marke <- freq_table_df(data, "Markė")

# 2. Modelis
freq_modelis <- freq_table_df(data, "Modelis")

# 3. Kėbulo tipas
freq_kebulas <- freq_table_df(data, "Kėbulo tipas")

# 4. Pavarų dėžės tipas
freq_pavare <- freq_table_df(data, "Pavarų dėžės tipas")

# 5. Kuro tipas
freq_kuras <- freq_table_df(data, "Kuro tipas")
```


```{r}
library(dplyr)
library(ggplot2)

# Funkcija: vidurkis su dispersija kaip taškas + klaidų juosta
mean_point_plot <- function(data, var_name) {
  summary_df <- data %>%
    group_by(.data[[var_name]]) %>%
    summarise(
      mean_CO2 = mean(`CO2 emisijos (g/km)`, na.rm = TRUE),
      sd_CO2 = sd(`CO2 emisijos (g/km)`, na.rm = TRUE),
      n = n(),
      .groups = "drop"
    ) %>%
    mutate(se = sd_CO2 / sqrt(n))  # standartinė paklaida, jei nori

  n_levels <- nrow(summary_df)
  colors <- rainbow(n_levels)

  ggplot(summary_df, aes(x = .data[[var_name]], y = mean_CO2, color = .data[[var_name]])) +
    geom_point(size = 3) +  # vidurkio taškas
    geom_errorbar(aes(ymin = mean_CO2 - sd_CO2, ymax = mean_CO2 + sd_CO2), width = 0.2) +
    scale_color_manual(values = colors) +
    theme_minimal() +
    labs(title = paste("Vidutinė CO2 emisija pagal", var_name),
         x = var_name,
         y = "Vidutinė CO2 emisija (g/km)") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
          axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
}

# 1. Markė
p_mean_marke <- mean_point_plot(data, "Markė")
print(p_mean_marke)

# 2. Modelis
p_mean_modelis <- mean_point_plot(data, "Modelis")
print(p_mean_modelis)

# 3. Kėbulo tipas
p_mean_kebulas <- mean_point_plot(data, "Kėbulo tipas")
print(p_mean_kebulas)

# 4. Pavarų dėžės tipas
p_mean_pavare <- mean_point_plot(data, "Pavarų dėžės tipas")
print(p_mean_pavare)

# 5. Kuro tipas
p_mean_kuras <- mean_point_plot(data, "Kuro tipas")
print(p_mean_kuras)
```