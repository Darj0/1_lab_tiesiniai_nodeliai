---
title: "tm1lab"
author: "vilte"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(dplyr)
library(stringr)

data <- read.csv("/Users/darjabaranova/Documents/VU/3_kursas/tiesiniai_metodai/CO2 Emissions_Canada.csv", header = TRUE)

data <- data[, - (ncol(data) - 1)]

data$logCO2 <- log(data$CO2.Emissions.g.km.)
names(data) <- c("Markė",
                 "Modelis",
                 "Kėbulo tipas",
                 "Variklio tūris (l)",
                 "Cilindrų skaičius",
                 "Pavarų dėžės tipas",
                 "Kuro tipas",
                 "Kuro sąnaudos mieste (l/100km)",
                 "Kuro sąnaudos greitkelyje (l/100km)",
                 "Vidutinės kuro sąnaudos (l/100km)",
                 "Vidutinės kuro sąnaudos (mpg)",
                 "CO2 emisijos (g/km)")

library(dplyr)

data <- data %>%
  mutate(
    `Kėbulo tipas` = str_trim(`Kėbulo tipas`),
    `Kėbulo grupė` = case_when(
      `Kėbulo tipas` %in% c("COMPACT", "MINICOMPACT", "SUBCOMPACT") ~ "Hečbekas",
      `Kėbulo tipas` %in% c("MID-SIZE", "FULL-SIZE")                ~ "Sedanas / Limuzinas",
      `Kėbulo tipas` %in% c("TWO-SEATER")                           ~ "Kupė / 2 vietų",
      `Kėbulo tipas` %in% c("STATION WAGON - SMALL", "STATION WAGON - MID-SIZE") ~ "Universalas",
      `Kėbulo tipas` %in% c("SUV - SMALL", "SUV - STANDARD")        ~ "SUV",
      `Kėbulo tipas` %in% c("MINIVAN")                              ~ "Vienatūris",
      `Kėbulo tipas` %in% c("VAN - CARGO", "VAN - PASSENGER")       ~ "Furgonas",
      `Kėbulo tipas` %in% c("PICKUP TRUCK - SMALL", "PICKUP TRUCK - STANDARD") ~ "Pikapas",
      `Kėbulo tipas` %in% c("SPECIAL PURPOSE VEHICLE")              ~ "Specialus",
      is.na(`Kėbulo tipas`) ~ NA_character_,
      TRUE ~ "Kita"
    )
  )

kuras_map_lt <- c(
  X = "Benzinas (reguliarus)",
  Z = "Benzinas (premium)",
  D = "Dyzelinas",
  E = "Etanolis (E85)",
  N = "Gamtinės dujos"
)

data <- data %>%
  mutate(
    .fuel_src = str_to_upper(str_squish(`Kuro tipas`)),
    fuel_code = str_extract(.fuel_src, "^[A-Z]"),  # pirmoji raidė: X/Z/D/E/N
    `Kuro tipas (LT)` = dplyr::recode(
      fuel_code,
      !!!as.list(kuras_map_lt),
      .default = "Kita"
    )
  ) %>%
  select(-.fuel_src)


data <- data %>%
  mutate(
    .src  = str_to_upper(str_squish(`Pavarų dėžės tipas`)),
    code  = str_extract(.src, "^[A-Z]+"),  # A, AM, AS, AV, M
    `Pavaru dežės tipai` = dplyr::recode(
      code,
      "A"  = "Automatinė",
      "AM" = "Automatinė (automatinė mechaninė)",
      "AS" = "Automatinė (su perjungimo pasirinkimu)",
      "AV" = "CVT (nepertraukiamo kintamumo)",
      "M"  = "Mechaninė",
      .default = "Kita"
    )
  ) %>%
  select(-.src, -code)

```

```{r}
# Histograma su log10 transformuotomis CO2 emisijomis
hist(data$`CO2 emisijos (g/km)`,
     breaks = 40,
     probability = TRUE,
     main = "Automobilių CO2 emisijų pasiskirstymo histograma",
     xlab = "CO2 emisijos (g/km)",
     ylab = "Tankis",
     col = "lightblue",
     border = "black")

# Normalioji kreivė
x <- seq(min(data$`CO2 emisijos (g/km)`, na.rm=TRUE), max(data$`CO2 emisijos (g/km)`, na.rm=TRUE), length=100)
y <- dnorm(x, 
           mean=mean(data$`CO2 emisijos (g/km)`, na.rm=TRUE), 
           sd=sd(data$`CO2 emisijos (g/km)`, na.rm=TRUE))
lines(x, y, col="red", lwd=2)

legend(x = 5.8, y = 1.6,
       legend = c("CO2 emisijų pasiskirstymas", "Normalumo kreivė"),
       pch    = c(22, NA),              
       pt.cex = c(2, NA),               
       col    = c("black", "red"),      
       pt.bg  = c("lightblue", NA),     
       pt.lwd = c(1.5, NA),             
       lwd    = c(NA, 2),
       bty    = "n")

#QQ grafikas
library(car)

qqPlot(data$`CO2 emisijos (g/km)`, 
       dist = "norm",
       main = "QQ CO2 emisijų grafikas",
       xlab = "Teoriniai kvantiliai",
       ylab = "Stebėtos CO2 emisijos (g/km)")

```
```{r}
# Statistinis Andersono-Darlingo testas
library(nortest)
ad.test(data$`CO2 emisijos (g/km)`)
```

```{r}
library(corrplot)
library(GGally)
library(ggplot2)

# 1. Paruošiami kiekybiniai kintamieji
numeric_vars <- data[, sapply(data, is.numeric)]
colnames(numeric_vars) <- c("Variklio tūris (l)",
                            "Cilindrų\nskaičius",
                            "Kuro sąnaudos\nmieste (l/100km)",
                            "Kuro sąnaudos\ngreitkelyje (l/100km)",
                            "Vidutinės kuro\nsąnaudos (l/100km)",
                            "Vidutinės kuro\nsąnaudos (mpg)",
                            "CO2 emisijos (g/km)")

numeric_vars <- numeric_vars[, !colnames(numeric_vars) %in% 
                                c("Vidutinės kuro\nsąnaudos (l/100km)",
                                  "Vidutinės kuro\nsąnaudos (mpg)")]
# 2. Koreliacijų matrica
cor_matrix <- cor(numeric_vars, use = "complete.obs")

# 3. Heatmap su numbers metodu
corrplot(cor_matrix,
         method = "number",  
         type = "upper",      
         tl.col = "black",    
         tl.srt = 90,         
         number.cex = 0.8,    
         addCoef.col = "black") 

# 4. Sklaidos grafikų matrica
upper_fun <- function(data, mapping, ...) {
  ggplot(data, mapping) +
    geom_point(alpha = 0.5, color = "deepskyblue3") +         
    geom_smooth(method = "lm", se = FALSE, color = "red", lwd = 1) + 
    theme_minimal()
}

diag_fun <- function(data, mapping, ...) {
  var <- as_label(mapping$x)
  ggplot() +
    annotate("text", x = 0.5, y = 0.5, label = var, size = 4, fontface = "bold") +
    theme_void()
}

p <- suppressMessages(
  suppressWarnings(
    ggpairs(numeric_vars,
        upper = list(continuous = wrap("points", alpha = 0.5, color = "deepskyblue3")),
        lower = list(continuous = wrap("smooth_loess", color = "red")),
        diag  = list(continuous = wrap("densityDiag")),    
            progress = FALSE) +
      ggtitle("Sklaidos grafikų matrica") +
      theme(plot.title = element_text(hjust = 0.5, face = "bold"))
  )
)

# Išsaugom kaip PNG 
#ggsave(filename = "/Users/meliu/Desktop/scatter_matrix.png",
#       plot = p, width = 12, height = 12, dpi = 300)


```

```{r}
library(dplyr)
library(ggplot2)
library(colorspace)


dep_var <- "CO2 emisijos (g/km)"

# ===== 1. Top 10 markių =====
top_brands <- data %>%
  dplyr::group_by(Markė) %>%
  dplyr::summarise(Dažnis = dplyr::n(), .groups = "drop") %>%
  dplyr::arrange(desc(Dažnis)) %>%
  dplyr::slice_head(n = 10) %>%
  dplyr::pull(Markė)

data <- data %>%
  mutate(Markė_top = ifelse(Markė %in% top_brands, Markė, "Kiti"))

# Grafikas pagal Markė_top
p1 <- ggplot(data, aes(x = Markė_top, y = `CO2 emisijos (g/km)`, fill = Markė_top)) +
  geom_boxplot(color = "black") +
  scale_fill_manual(values = rainbow_hcl(length(unique(data$Markė_top)), c = 60, l = 80)) +
  theme_minimal() +
  labs(title = "Top 10 markių + Kiti",
       x = "Markė",
       y = "CO2 emisijos (g/km)") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "none",
        axis.line.x = element_line(color = "black", linewidth = 0.5),
        axis.line.y = element_line(color = "black", linewidth = 0.5),
        axis.ticks = element_line(color = "black", linewidth = 0.5)
  )
print(p1)




# ===== Funkcija kategoriniams kintamiesiems =====
plot_box_rainbow <- function(data, var_name, title) {
  n_levels <- length(unique(data[[var_name]]))
  
  ggplot(data, aes(x = .data[[var_name]], 
                   y = `CO2 emisijos (g/km)`, 
                   fill = .data[[var_name]])) +
    geom_boxplot(color = "black") +
    scale_fill_manual(values = rainbow_hcl(n_levels, c = 60, l = 80)) +
    theme_minimal() +
    labs(title = title,
         x = var_name,
         y = "CO2 emisijos (g/km)") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
          axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "none",
          axis.line.x = element_line(color = "black", linewidth = 0.5),
          axis.line.y = element_line(color = "black", linewidth = 0.5),
          axis.ticks = element_line(color = "black", linewidth = 0.5)
          )
}

# 3. Kėbulo tipas
p3 <- plot_box_rainbow(data, "Kėbulo grupė", "CO2 emisijos pagal kėbulo tipą")
print(p3)

# 4. Pavarų dėžės tipas
# 4. Pavarų dėžės tipai (naujas stulpelis)
p4 <- plot_box_rainbow(data, "Pavaru dežės tipai", "CO2 emisijos pagal pavarų dėžės tipą")
print(p4)


# 5. Kuro tipas (pašalinam "N")
# Pašalinam stebėjimus su kuro tipu "N"
# Pašaliname 'Gamtinės dujos' iš LT stulpelio
data <- data %>%
  dplyr::filter(`Kuro tipas (LT)` != "Gamtinės dujos")

# Grafikas pagal LT pavadinimus
p5 <- plot_box_rainbow(data, "Kuro tipas (LT)", "CO2 emisijos pagal kuro tipą") +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

print(p5)



```
```{r}
library(dplyr)

# Funkcija dažnių lentelei 
library(dplyr)

freq_table_df <- function(data, var_name) {
  data %>%
    dplyr::group_by(.data[[var_name]]) %>%
    dplyr::summarise(Dažnis = dplyr::n(), .groups = "drop") %>%
    dplyr::arrange(desc(Dažnis))
}


# 1. Markė
freq_marke <- data %>%
  dplyr::mutate(
    Markė_top = ifelse(Markė %in% top_brands, Markė, "Kiti"),
    Markė_top = factor(Markė_top, levels = c(top_brands, "Kiti"))  # "Kiti" paskutinis
  ) %>%
  freq_table_df("Markė_top")



# 3. Kėbulo tipas
freq_kebulas <- freq_table_df(data, "Kėbulo grupė")

# 4. Pavarų dėžės tipas
freq_pavaros <- freq_table_df(data, "Pavaru dežės tipai")

# 5. Kuro tipas
data <- data %>%
 dplyr::filter(`Kuro tipas (LT)` != "Gamtinės dujos")
freq_kuras <- freq_table_df(data, "Kuro tipas (LT)")

freq_marke
freq_kebulas
freq_pavaros
freq_kuras
```


```{r}
library(dplyr)
library(ggplot2)

# Funkcija vidurkio su dispersija grafiko sudarymui
mean_point_plot <- function(data, var_name, filter_values = NULL, color = "black", title = NULL) {
  df <- data
  if (!is.null(filter_values)) {
    df <- df %>% filter(.data[[var_name]] %in% filter_values)
  }
  
 summary_df <- df %>%
  dplyr::group_by(.data[[var_name]]) %>%
  dplyr::summarise(
    mean_CO2 = mean(`CO2 emisijos (g/km)`, na.rm = TRUE),
    sd_CO2   = sd(`CO2 emisijos (g/km)`, na.rm = TRUE),
    n        = dplyr::n(),   # <-- pakeista
    .groups  = "drop"
  ) %>%
  dplyr::mutate(se = sd_CO2 / sqrt(n))

  
  ggplot(summary_df, aes(x = .data[[var_name]], y = mean_CO2)) +
    geom_point(size = 3, color = color) +
    geom_errorbar(aes(ymin = mean_CO2 - sd_CO2, ymax = mean_CO2 + sd_CO2),
                  width = 0.2, color = color) +
    theme_minimal() +
    labs(title = title,
         x = var_name,
         y = "Vidutinės CO2 emisijos (g/km)") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
          axis.text.x = element_text(angle = 90, hjust = 1),
          axis.line.x = element_line(color = "black", linewidth = 0.5),
          axis.line.y = element_line(color = "black", linewidth = 0.5),
          axis.ticks = element_line(color = "black", linewidth = 0.5))
}

# 1. Markė 
data <- data %>%
  mutate(
    Markė_top = ifelse(Markė %in% top_brands, Markė, "Kiti"),
    Markė_top = factor(Markė_top, levels = c(top_brands, "Kiti"))
  )

p_mean_marke <- mean_point_plot(
  data,
  var_name = "Markė_top",
  color = "navy",
  title = "Vidutinės CO2 emisijos pagal TOP 10 markių ir Kiti"
)
print(p_mean_marke)




# 3. Kėbulo tipas 
p_mean_kebulas <- mean_point_plot(data, "Kėbulo grupė",
                                  color = "darkviolet",
                                  title = "Vidutinės CO2 emisijos pagal kėbulo tipą")
print(p_mean_kebulas)

# 4. Pavarų dėžės tipas 
p_mean_pavare <- mean_point_plot(data, "Pavaru dežės tipai",
                                 color = "darkred",
                                 title = "Vidutinės CO2 emisijos pagal pavarų dėžės tipą")
print(p_mean_pavare)

# 5. Kuro tipas 
p_mean_kuras <- mean_point_plot(data, "Kuro tipas (LT)",
                                color = "darkgreen",
                                title = "Vidutinės CO2 emisijos pagal kuro tipą") +
                                theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
print(p_mean_kuras)

```